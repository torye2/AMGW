<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AMU GROUP WARE</title>

    <!-- Tailwind + site css -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <!-- CSRF (Thymeleaf) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="bg-slate-50 text-slate-800">
<div class="min-h-dvh grid grid-rows-[auto,1fr]">
    <!-- í—¤ë”/ì‚¬ì´ë“œë°” (ê³µìš© í”„ë˜ê·¸ë¨¼íŠ¸) -->
    <div th:replace="~{fragments/header :: siteHeader}"></div>

    <!-- ë³¸ë¬¸: ì‚¬ì´ë“œë°” + ë©”ì¸ -->
    <div class="container grid grid-cols-1 md:grid-cols-[240px,1fr] gap-4 sm:gap-6 py-4">
        <div th:replace="~{fragments/sidebar :: siteSidebar}"></div>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
        <main class="space-y-4 md:space-y-6">
            <!-- ì¸ì‚¬ë§ + í€µì•¡ì…˜ -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="card lg:col-span-2">
                    <div th:if="${me != null}">
                        <h1 id="greeting" class="h1" th:text="'ì•ˆë…•í•˜ì„¸ìš”, ' + ${me.name} + 'ë‹˜ ğŸ‘‹'">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹</h1>
                    </div>
                    <p id="greetingSub" class="muted" th:text="${#temporals.format(#temporals.createNow(), 'Mì›” dì¼ (EEE)')}">ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”.</p>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <a href="/approvals/new" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            ìƒˆ ê²°ì¬ ì‘ì„±
                        </a>
                        <a href="http://localhost:8085/apps/files/files" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            ìƒˆ ë¬¸ì„œ
                        </a>
                        <a th:href="@{/attendance}" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M4 11h16M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z"/></svg>
                            íœ´ê°€/ê·¼íƒœ ì‹ ì²­
                        </a>
                        <button id="btnSyncNextcloud" class="btn" th:if="${me?.roles?.contains('ROLE_ADMIN')}">ì‚¬ìš©ì ë™ê¸°í™”</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="h2">ê·¼íƒœ ìš”ì•½</h2>
                    <div id="attendanceBox" class="grid grid-cols-2 gap-3 text-sm mt-3">
                        <div class="pill">
                            <div class="muted">ì˜¤ëŠ˜ ì¶œê·¼</div>
                            <div id="checkIn" class="pill-value skeleton">--:--</div>
                        </div>
                        <div class="pill">
                            <div class="muted">ì£¼ê°„ ê·¼ë¬´</div>
                            <div id="weeklyHours" class="pill-value skeleton">--ì‹œê°„</div>
                        </div>
                        <div class="pill">
                            <div class="muted">ì”ì—¬ ì—°ì°¨</div>
                            <div id="vacationLeft" class="pill-value skeleton">14ì¼</div>
                        </div>
                        <div class="pill">
                            <div class="muted">ìƒíƒœ</div>
                            <div id="statusNow" class="pill-value skeleton">-</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ: ê²°ì¬/ì¼ì •/ë¬¸ì„œ/ê³µì§€ -->
            <section class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6">
                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">ê²°ì¬ ëŒ€ê¸°</h2>
                        <a href="/approvals" class="link">ì „ì²´ ë³´ê¸°</a>
                    </div>
                    <ul id="approvalsList" class="list">
                        <li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">ì˜¤ëŠ˜ ì¼ì •</h2>
                        <a href="/calendar" class="link">ìº˜ë¦°ë”</a>
                    </div>
                    <ul id="todayEvents" class="list">
                        <li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">ìµœê·¼ ë¬¸ì„œ</h2>
                        <a href="http://localhost:8085/apps/files/?view=recent" class="link">ë¬¸ì„œí•¨</a>
                    </div>
                    <ul id="recentDocs" class="list">
                        <li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
                    </ul>
                </article>

                <article class="card xl:col-span-2">
                    <div class="card-head">
                        <h2 class="h2">ê³µì§€ì‚¬í•­</h2>
                        <a href="/Notice_L" class="link">ê²Œì‹œíŒ</a>
                    </div>
                    <ul id="notices" class="list">
                        <li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">To-Do</h2>
                        <button id="btnAddTodo" class="btn btn-ghost">ì¶”ê°€</button>
                    </div>
                    <ul id="todoList" class="list"></ul>
                </article>
            </section>
        </main>
    </div>
</div>

<!-- ê³µìš© ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
<script defer th:src="@{/js/index.js}"></script>
<script defer th:src="@{/js/indexAttendanceSummary.js}"></script>
<script src="/js/chatWidget.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js" defer></script>
<script src="/js/notifications.js" defer></script>

<script>
    // ---- ê³µí†µ CSRF ----
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // ---- ì‘ì€ ìœ í‹¸ ----
    function apEl(tag, className, html){
      const x = document.createElement(tag);
      if(className) x.className = className;
      if(html != null) x.innerHTML = html;
      return x;
    }
    function toYmdLocal(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function fmtHm(isoOrDate){
      if(!isoOrDate) return '';
      const d = (isoOrDate instanceof Date) ? isoOrDate : new Date(isoOrDate);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    async function syncNextcloud() {
        const btn = document.getElementById('btnSyncNextcloud');
        if (!btn) return;

        const origHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'ë™ê¸°í™” ì¤‘â€¦';

        try {
            const res = await fetch('/admin/sync/nextcloud', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {})
                },
                credentials: 'same-origin' // ì„¸ì…˜/ì¿ í‚¤ ì‚¬ìš©
            });

            // ì„œë²„ê°€ 200/204ë¡œë§Œ ì£¼ë©´ í…ìŠ¤íŠ¸ ê±´ë„ˆë›°ê³  ìƒíƒœë§Œ í™•ì¸í•´ë„ OK
            if (res.ok) {
                toast('Nextcloud ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ âœ…');
            } else {
                const msg = await safeReadError(res);
                toast(`ë™ê¸°í™” ì‹¤íŒ¨: ${msg}`, true);
            }
        } catch (e) {
            console.error(e);
            toast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
        } finally {
            btn.disabled = false;
            btn.innerHTML = origHtml;
        }
    }

    async function safeReadError(res){
        try {
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                const j = await res.json();
                return j.message || j.error || res.statusText;
            } else {
                return (await res.text()) || res.statusText;
            }
        } catch { return res.statusText; }
    }

    // ì•„ì£¼ ë‹¨ìˆœí•œ í† ìŠ¤íŠ¸
    function toast(message, isError=false){
        const el = document.createElement('div');
        el.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow ${
            isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'
        }`;
        el.textContent = message;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 3000);
    }

    // =========================
    // ê²°ì¬ ëŒ€ê¸° ì¹´ë“œ
    // =========================
    async function loadApprovalsWaiting(){
      const ul = document.getElementById('approvalsList');
      if(!ul) return;
      ul.innerHTML = '<li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>';

      try{
        const res = await fetch('/api/approvals/inbox', { credentials: 'same-origin' });
        if(!res.ok) throw new Error('inbox load failed');
        const items = await res.json();

        ul.innerHTML = '';
        if(!items?.length){
          ul.appendChild(apEl('li','list-item muted','ê²°ì¬í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.'));
          return;
        }

        items.slice(0,5).forEach(d=>{
          const li = apEl('li','list-item', `
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="font-medium truncate">
                  <a class="link" href="/approvals/${d.id}">${d.title ?? '(ì œëª© ì—†ìŒ)'}</a>
                </div>
                <div class="muted text-sm">
                  ê¸°ì•ˆì #${d.drafterId} Â· ì¢…ë¥˜ ${d.docType} Â· ìƒíƒœ ${d.status}
                </div>
              </div>
              <div class="flex-shrink-0 flex gap-2">
                <a class="btn btn-ghost" href="/approvals/${d.id}">ë³´ê¸°</a>
                <button class="btn" data-approve="${d.id}">ìŠ¹ì¸</button>
                <button class="btn btn-ghost" data-reject="${d.id}">ë°˜ë ¤</button>
              </div>
            </div>
          `);
          ul.appendChild(li);
        });

        // ìŠ¹ì¸/ë°˜ë ¤ ìœ„ì„
        ul.onclick = async (e)=>{
          const idA = e.target?.dataset?.approve;
          const idR = e.target?.dataset?.reject;
          if(!idA && !idR) return;

          const url = idA ? `/api/approvals/${idA}/approve`
                          : `/api/approvals/${idR}/reject`;
          try{
            const r = await fetch(url, {
              method:'POST',
              headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {},
              credentials: 'same-origin'
            });
            const j = await r.json().catch(()=>({ ok:false }));
            if(j.ok) await loadApprovalsWaiting();
            else alert('ì²˜ë¦¬ ì‹¤íŒ¨');
          }catch(err){
            console.error(err);
            alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        };
      }catch(err){
        console.error(err);
        ul.innerHTML = '<li class="list-item muted">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
      }
    }

    // =========================
    // ì˜¤ëŠ˜ ì¼ì • ì¹´ë“œ (ìº˜ë¦°ë” ì—°ë™)
    // =========================
    async function loadTodayEvents(){
        const ul = document.getElementById('todayEvents');
        if(!ul) return;
        ul.innerHTML = '<li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>';

        // YYYY-MM-DD í¬ë§· ë„ìš°ë¯¸
        const toYmd = (d) => {
            const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${dd}`;
        };

        const today = new Date();
        const startDay = toYmd(today);
        const tomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);
        const endDay = toYmd(tomorrow); // â† ë‹¤ìŒë‚  00:00 (ë°°íƒ€êµ¬ê°„ì˜ ë)

        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Seoul';
        const url = `/api/calendar/events?start=${encodeURIComponent(startDay)}&end=${encodeURIComponent(endDay)}&tz=${encodeURIComponent(tz)}`;

        try {
            const r = await fetch(url, { credentials:'same-origin' });
            if(!r.ok){
            const t = await r.text().catch(()=> '');
            console.warn('todayEvents load failed', r.status, t);
            ul.innerHTML = '<li class="list-item muted">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
            return;
            }
            const arr = await r.json();

            ul.innerHTML = '';
            if(!arr?.length){
            ul.innerHTML = '<li class="list-item muted">ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            return;
            }

            const fmtHm = (iso) => {
            if(!iso) return '';
            const d = new Date(iso);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            arr.forEach(ev=>{
            const time = ev.allDay ? 'ì¢…ì¼' : (ev.start ? `${fmtHm(ev.start)}${ev.end ? 'â€“'+fmtHm(ev.end):''}` : '');
            const where = ev.location ? ` Â· ${ev.location}` : '';
            ul.insertAdjacentHTML('beforeend', `
                <li class="list-item">
                <div class="flex items-center justify-between gap-3">
                    <div class="min-w-0">
                    <div class="font-medium truncate">${ev.title ?? '(ì œëª© ì—†ìŒ)'}</div>
                    <div class="muted text-sm">${time}${where}</div>
                    </div>
                    ${ev.color ? `<span class="inline-block w-3 h-3 rounded-full" style="background:${ev.color}"></span>`:''}
                </div>
                </li>
            `);
            });
        } catch (e) {
            console.error(e);
            ul.innerHTML = '<li class="list-item muted">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
        }
        }


    // =========================
    // To-Do ì¹´ë“œ
    // =========================
    const todoListEl = document.getElementById('todoList');
    const btnAddTodo = document.getElementById('btnAddTodo');

    async function loadTodosCard(){
      if(!todoListEl) return;
      todoListEl.innerHTML = '<li class="list-item skeleton">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>';

      try{
        const res = await fetch('/api/todos', { credentials:'same-origin' });
        if(!res.ok) throw new Error('todos load failed');
        const arr = await res.json();

        todoListEl.innerHTML = '';
        if(!arr?.length){
          todoListEl.innerHTML = '<li class="list-item muted">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
          return;
        }

        arr.slice(0,5).forEach(t=>{
          const li = document.createElement('li');
          li.className = 'list-item';
          const due = t.dueDate ? ` Â· ë§ˆê° ${t.dueDate}` : '';
          const pr  = t.priority ? ` Â· ${t.priority}` : '';
          li.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <label class="flex items-center gap-3 min-w-0">
                <input type="checkbox" data-id="${t.id}" ${t.done?'checked':''} class="accent-slate-700">
                <a class="truncate ${t.done?'line-through text-slate-400':''}" href="/todos">${t.title}</a>
              </label>
              <div class="muted text-sm shrink-0">${due}${pr}</div>
            </div>
          `;
          todoListEl.appendChild(li);
        });
      }catch(err){
        console.error(err);
        todoListEl.innerHTML = '<li class="list-item muted">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
      }
    }

    // ì™„ë£Œ í† ê¸€
    todoListEl?.addEventListener('change', async (e)=>{
      const cb = e.target;
      if(cb.type === 'checkbox' && cb.dataset.id){
        try{
          await fetch(`/api/todos/${cb.dataset.id}`, {
            method:'PATCH',
            headers:{ 'Content-Type':'application/json', ...(csrfHeader&&csrfToken?{[csrfHeader]:csrfToken}:{}) },
            credentials:'same-origin',
            body: JSON.stringify({ done: cb.checked })
          });
          const a = cb.closest('label')?.querySelector('a');
          if(a){
            if(cb.checked){ a.classList.add('line-through','text-slate-400'); }
            else { a.classList.remove('line-through','text-slate-400'); }
          }
        }catch(err){ console.warn(err); }
      }
    });

    // ì¶”ê°€ ë²„íŠ¼ ì´ë™
    btnAddTodo?.addEventListener('click', ()=>{ location.href = '/todos/new'; });

    // ì´ˆê¸° ë¡œë”©
    document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('btnSyncNextcloud')?.addEventListener('click', syncNextcloud);
        loadApprovalsWaiting();
        loadTodayEvents();  // â† ì˜¤ëŠ˜ ì¼ì • ì¹´ë“œ ì±„ìš°ê¸°
        loadTodosCard();
    });
</script>
</body>
</html>
