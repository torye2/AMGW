<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AMU GROUP WARE</title>

    <!-- Tailwind + site css -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <!-- CSRF (Thymeleaf) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="bg-slate-50 text-slate-800">
<div class="min-h-dvh grid grid-rows-[auto,1fr]">
    <!-- 헤더/사이드바 (공용 프래그먼트) -->
    <div th:replace="~{fragments/header :: siteHeader}"></div>

    <!-- 본문: 사이드바 + 메인 -->
    <div class="container grid grid-cols-1 md:grid-cols-[240px,1fr] gap-4 sm:gap-6 py-4">
        <div th:replace="~{fragments/sidebar :: siteSidebar}"></div>

        <!-- 메인 대시보드 -->
        <main class="space-y-4 md:space-y-6">
            <!-- 인사말 + 퀵액션 -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="card lg:col-span-2">
                    <div th:if="${me != null}">
                        <h1 id="greeting" class="h1" th:text="'안녕하세요, ' + ${me.name} + '님 👋'">안녕하세요 👋</h1>
                    </div>
                    <p id="greetingSub" class="muted" th:text="${#temporals.format(#temporals.createNow(), 'M월 d일 (EEE)')}">오늘도 좋은 하루 보내세요.</p>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <a href="/approvals/new" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            새 결재 작성
                        </a>
                        <a href="http://localhost:8085/apps/files/files" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            새 문서
                        </a>
                        <a th:href="@{/attendance}" class="btn">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M4 11h16M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z"/></svg>
                            휴가/근태 신청
                        </a>
                        <button id="btnSyncNextcloud" class="btn" th:if="${me?.roles?.contains('ROLE_ADMIN')}">사용자 동기화</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="h2">근태 요약</h2>
                    <div id="attendanceBox" class="grid grid-cols-2 gap-3 text-sm mt-3">
                        <div class="pill">
                            <div class="muted">오늘 출근</div>
                            <div id="checkIn" class="pill-value skeleton">--:--</div>
                        </div>
                        <div class="pill">
                            <div class="muted">주간 근무</div>
                            <div id="weeklyHours" class="pill-value skeleton">--시간</div>
                        </div>
                        <div class="pill">
                            <div class="muted">잔여 연차</div>
                            <div id="vacationLeft" class="pill-value skeleton">14일</div>
                        </div>
                        <div class="pill">
                            <div class="muted">상태</div>
                            <div id="statusNow" class="pill-value skeleton">-</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 카드 그리드: 결재/일정/문서/공지 -->
            <section class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6">
                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">결재 대기</h2>
                        <a href="/approvals" class="link">전체 보기</a>
                    </div>
                    <ul id="approvalsList" class="list">
                        <li class="list-item skeleton">불러오는 중…</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">오늘 일정</h2>
                        <a href="/calendar" class="link">캘린더</a>
                    </div>
                    <ul id="todayEvents" class="list">
                        <li class="list-item skeleton">불러오는 중…</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">최근 문서</h2>
                        <a href="http://localhost:8085/apps/files/?view=recent" class="link">문서함</a>
                    </div>
                    <ul id="recentDocs" class="list">
                        <li class="list-item skeleton">불러오는 중…</li>
                    </ul>
                </article>

                <article class="card xl:col-span-2">
                    <div class="card-head">
                        <h2 class="h2">공지사항</h2>
                        <a href="/Notice_L" class="link">게시판</a>
                    </div>
                    <ul id="notices" class="list">
                        <li class="list-item skeleton">불러오는 중…</li>
                    </ul>
                </article>

                <article class="card">
                    <div class="card-head">
                        <h2 class="h2">To-Do</h2>
                        <button id="btnAddTodo" class="btn btn-ghost">추가</button>
                    </div>
                    <ul id="todoList" class="list"></ul>
                </article>
            </section>
        </main>
    </div>
</div>

<!-- 공용 스크립트들 -->
<script defer th:src="@{/js/index.js}"></script>
<script defer th:src="@{/js/indexAttendanceSummary.js}"></script>
<script src="/js/chatWidget.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js" defer></script>
<script src="/js/notifications.js" defer></script>

<script>
    // ---- 공통 CSRF ----
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // ---- 작은 유틸 ----
    function apEl(tag, className, html){
      const x = document.createElement(tag);
      if(className) x.className = className;
      if(html != null) x.innerHTML = html;
      return x;
    }
    function toYmdLocal(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function fmtHm(isoOrDate){
      if(!isoOrDate) return '';
      const d = (isoOrDate instanceof Date) ? isoOrDate : new Date(isoOrDate);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    async function syncNextcloud() {
        const btn = document.getElementById('btnSyncNextcloud');
        if (!btn) return;

        const origHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '동기화 중…';

        try {
            const res = await fetch('/admin/sync/nextcloud', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {})
                },
                credentials: 'same-origin' // 세션/쿠키 사용
            });

            // 서버가 200/204로만 주면 텍스트 건너뛰고 상태만 확인해도 OK
            if (res.ok) {
                toast('Nextcloud 동기화가 완료되었습니다 ✅');
            } else {
                const msg = await safeReadError(res);
                toast(`동기화 실패: ${msg}`, true);
            }
        } catch (e) {
            console.error(e);
            toast('네트워크 오류로 동기화에 실패했습니다.', true);
        } finally {
            btn.disabled = false;
            btn.innerHTML = origHtml;
        }
    }

    async function safeReadError(res){
        try {
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                const j = await res.json();
                return j.message || j.error || res.statusText;
            } else {
                return (await res.text()) || res.statusText;
            }
        } catch { return res.statusText; }
    }

    // 아주 단순한 토스트
    function toast(message, isError=false){
        const el = document.createElement('div');
        el.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow ${
            isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'
        }`;
        el.textContent = message;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 3000);
    }

    // =========================
    // 결재 대기 카드
    // =========================
    async function loadApprovalsWaiting(){
      const ul = document.getElementById('approvalsList');
      if(!ul) return;
      ul.innerHTML = '<li class="list-item skeleton">불러오는 중…</li>';

      try{
        const res = await fetch('/api/approvals/inbox', { credentials: 'same-origin' });
        if(!res.ok) throw new Error('inbox load failed');
        const items = await res.json();

        ul.innerHTML = '';
        if(!items?.length){
          ul.appendChild(apEl('li','list-item muted','결재할 문서가 없습니다.'));
          return;
        }

        items.slice(0,5).forEach(d=>{
          const li = apEl('li','list-item', `
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="font-medium truncate">
                  <a class="link" href="/approvals/${d.id}">${d.title ?? '(제목 없음)'}</a>
                </div>
                <div class="muted text-sm">
                  기안자 #${d.drafterId} · 종류 ${d.docType} · 상태 ${d.status}
                </div>
              </div>
              <div class="flex-shrink-0 flex gap-2">
                <a class="btn btn-ghost" href="/approvals/${d.id}">보기</a>
                <button class="btn" data-approve="${d.id}">승인</button>
                <button class="btn btn-ghost" data-reject="${d.id}">반려</button>
              </div>
            </div>
          `);
          ul.appendChild(li);
        });

        // 승인/반려 위임
        ul.onclick = async (e)=>{
          const idA = e.target?.dataset?.approve;
          const idR = e.target?.dataset?.reject;
          if(!idA && !idR) return;

          const url = idA ? `/api/approvals/${idA}/approve`
                          : `/api/approvals/${idR}/reject`;
          try{
            const r = await fetch(url, {
              method:'POST',
              headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {},
              credentials: 'same-origin'
            });
            const j = await r.json().catch(()=>({ ok:false }));
            if(j.ok) await loadApprovalsWaiting();
            else alert('처리 실패');
          }catch(err){
            console.error(err);
            alert('요청 중 오류가 발생했습니다.');
          }
        };
      }catch(err){
        console.error(err);
        ul.innerHTML = '<li class="list-item muted">불러오기에 실패했습니다.</li>';
      }
    }

    // =========================
    // 오늘 일정 카드 (캘린더 연동)
    // =========================
    async function loadTodayEvents(){
        const ul = document.getElementById('todayEvents');
        if(!ul) return;
        ul.innerHTML = '<li class="list-item skeleton">불러오는 중…</li>';

        // YYYY-MM-DD 포맷 도우미
        const toYmd = (d) => {
            const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${dd}`;
        };

        const today = new Date();
        const startDay = toYmd(today);
        const tomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);
        const endDay = toYmd(tomorrow); // ← 다음날 00:00 (배타구간의 끝)

        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Seoul';
        const url = `/api/calendar/events?start=${encodeURIComponent(startDay)}&end=${encodeURIComponent(endDay)}&tz=${encodeURIComponent(tz)}`;

        try {
            const r = await fetch(url, { credentials:'same-origin' });
            if(!r.ok){
            const t = await r.text().catch(()=> '');
            console.warn('todayEvents load failed', r.status, t);
            ul.innerHTML = '<li class="list-item muted">일정을 불러오지 못했습니다.</li>';
            return;
            }
            const arr = await r.json();

            ul.innerHTML = '';
            if(!arr?.length){
            ul.innerHTML = '<li class="list-item muted">오늘 일정이 없습니다.</li>';
            return;
            }

            const fmtHm = (iso) => {
            if(!iso) return '';
            const d = new Date(iso);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            arr.forEach(ev=>{
            const time = ev.allDay ? '종일' : (ev.start ? `${fmtHm(ev.start)}${ev.end ? '–'+fmtHm(ev.end):''}` : '');
            const where = ev.location ? ` · ${ev.location}` : '';
            ul.insertAdjacentHTML('beforeend', `
                <li class="list-item">
                <div class="flex items-center justify-between gap-3">
                    <div class="min-w-0">
                    <div class="font-medium truncate">${ev.title ?? '(제목 없음)'}</div>
                    <div class="muted text-sm">${time}${where}</div>
                    </div>
                    ${ev.color ? `<span class="inline-block w-3 h-3 rounded-full" style="background:${ev.color}"></span>`:''}
                </div>
                </li>
            `);
            });
        } catch (e) {
            console.error(e);
            ul.innerHTML = '<li class="list-item muted">일정을 불러오지 못했습니다.</li>';
        }
        }


    // =========================
    // To-Do 카드
    // =========================
    const todoListEl = document.getElementById('todoList');
    const btnAddTodo = document.getElementById('btnAddTodo');

    async function loadTodosCard(){
      if(!todoListEl) return;
      todoListEl.innerHTML = '<li class="list-item skeleton">불러오는 중…</li>';

      try{
        const res = await fetch('/api/todos', { credentials:'same-origin' });
        if(!res.ok) throw new Error('todos load failed');
        const arr = await res.json();

        todoListEl.innerHTML = '';
        if(!arr?.length){
          todoListEl.innerHTML = '<li class="list-item muted">할 일이 없습니다.</li>';
          return;
        }

        arr.slice(0,5).forEach(t=>{
          const li = document.createElement('li');
          li.className = 'list-item';
          const due = t.dueDate ? ` · 마감 ${t.dueDate}` : '';
          const pr  = t.priority ? ` · ${t.priority}` : '';
          li.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <label class="flex items-center gap-3 min-w-0">
                <input type="checkbox" data-id="${t.id}" ${t.done?'checked':''} class="accent-slate-700">
                <a class="truncate ${t.done?'line-through text-slate-400':''}" href="/todos">${t.title}</a>
              </label>
              <div class="muted text-sm shrink-0">${due}${pr}</div>
            </div>
          `;
          todoListEl.appendChild(li);
        });
      }catch(err){
        console.error(err);
        todoListEl.innerHTML = '<li class="list-item muted">불러오기에 실패했습니다.</li>';
      }
    }

    // 완료 토글
    todoListEl?.addEventListener('change', async (e)=>{
      const cb = e.target;
      if(cb.type === 'checkbox' && cb.dataset.id){
        try{
          await fetch(`/api/todos/${cb.dataset.id}`, {
            method:'PATCH',
            headers:{ 'Content-Type':'application/json', ...(csrfHeader&&csrfToken?{[csrfHeader]:csrfToken}:{}) },
            credentials:'same-origin',
            body: JSON.stringify({ done: cb.checked })
          });
          const a = cb.closest('label')?.querySelector('a');
          if(a){
            if(cb.checked){ a.classList.add('line-through','text-slate-400'); }
            else { a.classList.remove('line-through','text-slate-400'); }
          }
        }catch(err){ console.warn(err); }
      }
    });

    // 추가 버튼 이동
    btnAddTodo?.addEventListener('click', ()=>{ location.href = '/todos/new'; });

    // 초기 로딩
    document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('btnSyncNextcloud')?.addEventListener('click', syncNextcloud);
        loadApprovalsWaiting();
        loadTodayEvents();  // ← 오늘 일정 카드 채우기
        loadTodosCard();
    });
</script>
</body>
</html>
