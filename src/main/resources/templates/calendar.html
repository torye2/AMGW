<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AMU GROUP WARE · 캘린더</title>

    <!-- Tailwind + site css -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <!-- CSRF (Thymeleaf) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- FullCalendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <style>
        .container { max-width: 1100px; margin: 0 auto; }
        /* 모달 */
        .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); z-index: 60; }
        .modal.open { display: flex; }
        .modal-panel { background: #fff; border-radius: .75rem; width: 100%; max-width: 520px; padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,.15); }
        .modal-open .fc { pointer-events: none; }
        .modal { pointer-events: auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
        .label { font-size: .875rem; color: #475569; margin-bottom: .25rem; display:block; }
        .input, .select, .textarea { width:100%; border:1px solid #e2e8f0; border-radius:.5rem; padding:.5rem .75rem; font-size:.95rem; outline:none; }
        .input:focus, .select:focus, .textarea:focus { border-color:#94a3b8; box-shadow: 0 0 0 3px rgba(148,163,184,.25); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="min-h-dvh grid grid-rows-[auto,1fr]">

    <!-- 헤더 -->
    <header class="site-header">
        <div class="container h-16 flex items-center gap-3 px-4">
            <a href="/" class="brand">
                <span class="brand-badge">GW</span>
                <span>Groupware</span>
            </a>
            <div class="ml-auto flex items-center gap-2">
                <a th:href="@{/}" class="btn btn-ghost">홈</a>
            </div>
        </div>
    </header>

    <!-- 본문 -->
    <main class="container px-4 py-6 space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-semibold">캘린더</h1>
                <p class="text-slate-500 text-sm">일정을 확인하고 추가하세요.</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnNewEvent" class="btn">+ 새 일정</button>
            </div>
        </div>

        <div id="calendar" class="bg-white rounded-xl border border-slate-200 p-2"></div>
    </main>
</div>

<!-- 일정 모달 -->
<div id="eventModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">일정</h3>
            <button id="btnCloseModal" class="icon-btn" aria-label="닫기" title="닫기" style="border:none;background:transparent;">✕</button>
        </div>
        <form id="eventForm" class="space-y-3">
            <div>
                <label class="label">제목</label>
                <input class="input" type="text" name="title" placeholder="예: 주간 스탠드업" required />
            </div>
            <div class="form-row">
                <div>
                    <label class="label">시작</label>
                    <input class="input" type="datetime-local" name="start" required />
                </div>
                <div>
                    <label class="label">종료</label>
                    <input class="input" type="datetime-local" name="end" />
                </div>
            </div>
            <div class="flex items-center gap-2">
                <input id="allDay" type="checkbox" class="accent-slate-700">
                <label for="allDay" class="text-sm text-slate-700">하루 종일</label>
            </div>
            <div>
                <label class="label">설명</label>
                <textarea class="textarea" name="description" rows="3" placeholder="설명(선택)"></textarea>
            </div>
            <div>
                <label class="label">장소</label>
                <input class="input" type="text" name="location" placeholder="회의실 A (선택)" />
            </div>
            <div class="flex items-center justify-end gap-2 pt-1">
                <button id="btnCancel" type="button" class="btn btn-ghost">취소</button>
                <button id="btnSave" type="button" class="btn">저장</button>
            </div>
        </form>
    </div>
</div>

<!-- index.js 로딩 제거(이 페이지에서 필요없다면) -->
<!-- <script defer th:src="@{/js/index.js}"></script> -->

<script>
    // ------ CSRF ------
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

    // ------ Modal helpers ------
    const modal = document.getElementById('eventModal');
    const form  = document.getElementById('eventForm');
    const btnNewEvent   = document.getElementById('btnNewEvent');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancel     = document.getElementById('btnCancel');
    const btnSave       = document.getElementById('btnSave');
    const allDayEl      = document.getElementById('allDay');

    function openModal({title='', start=null, end=null, allDay=false} = {}){
      form.title.value = title || '';
      allDayEl.checked = !!allDay;

      const toLocalInput = (d) => {
        if(!d) return '';
        const dt = (d instanceof Date) ? d : new Date(d);
        const pad = n => String(n).padStart(2,'0');
        const yyyy = dt.getFullYear();
        const mm   = pad(dt.getMonth()+1);
        const dd   = pad(dt.getDate());
        const hh   = pad(dt.getHours());
        const mi   = pad(dt.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      };

      const now = new Date();
      const startDefault = start ? new Date(start) : now;
      const endDefault   = end   ? new Date(end)   : new Date(now.getTime() + 60*60*1000);

      form.start.value = toLocalInput(startDefault);
      form.end.value   = toLocalInput(endDefault);

      document.documentElement.classList.add('modal-open');
      modal.classList.add('open');
    }
    function closeModal(){
      modal.classList.remove('open');
      document.documentElement.classList.remove('modal-open');
      delete form.dataset.eventId;
    }

    // 모달 내부 버튼: 이벤트 버블링 차단
    [btnSave, btnCancel, btnCloseModal].forEach(btn=>{
      btn?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    btnCancel.addEventListener('click', () => closeModal());
    btnCloseModal.addEventListener('click', () => closeModal());
    btnNewEvent?.addEventListener('click', () => openModal({}));

    // ------ FullCalendar ------
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      height: 'auto',
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      locale: 'ko',
      navLinks: true,
      selectable: true,
      dayMaxEvents: true,
      unselectCancel: '.modal, .modal *',   // 모달 열려 있을 때 배경 클릭 무시

      // 월/주 전환시 서버에서 이벤트 로드
      datesSet: async (info) => {
        try{
          const events = await loadEvents(info.start, info.end); // Date 객체 전달
          calendar.removeAllEvents();
          calendar.addEventSource(events);
        }catch(err){ console.error(err); }
      },

      dateClick: (info) => {
        openModal({ start: info.dateStr + 'T09:00', end: info.dateStr + 'T10:00', allDay: false });
      },
      select: (info) => {
        openModal({ start: info.startStr, end: info.endStr, allDay: info.allDay });
      },
      eventClick: (info) => {
        const ev = info.event;
        openModal({ title: ev.title, start: ev.start, end: ev.end || ev.start, allDay: ev.allDay });
        form.dataset.eventId = ev.id || '';
      }
    });
    calendar.render();

    // ------ 서버 연동: 목록 로드(YYYY-MM-DD로 요청) ------
    async function loadEvents(rangeStart, rangeEnd){
      const startStr = rangeStart.toISOString().slice(0,10); // 'YYYY-MM-DD'
      const endStr   = rangeEnd.toISOString().slice(0,10);   // 'YYYY-MM-DD' (배타구간)
      const tz       = Intl.DateTimeFormat().resolvedOptions().timeZone;

      const res = await fetch(`/api/calendar/events?start=${startStr}&end=${endStr}&tz=${encodeURIComponent(tz)}`, {
        credentials: 'same-origin'
      });
      if(!res.ok) throw new Error('failed to load events');
      return res.json(); // [{id,title,start,end,allDay,color,...}]
    }

    // ------ 저장(추가/수정) ------
    btnSave.addEventListener('click', async (e)=>{
      e.preventDefault();
      e.stopPropagation();

      const title = form.title.value.trim();
      const allDay = allDayEl.checked;
      const start  = form.start.value; // "YYYY-MM-DDTHH:mm"
      const end    = form.end.value;
      const description = form.description.value?.trim() || '';
      const location    = form.location.value?.trim() || '';

      if(!title){ form.title.focus(); return; }
      if(!start){ form.start.focus(); return; }

      const isUpdate = !!form.dataset.eventId;
      const url  = isUpdate ? `/api/calendar/events/${form.dataset.eventId}` : '/api/calendar/events';
      const meth = isUpdate ? 'PATCH' : 'POST'; // 백엔드 매핑과 일치!

      try{
        const res = await fetch(url, {
          method: meth,
          headers: {
            'Content-Type':'application/json',
            ...(CSRF_HEADER && CSRF_TOKEN ? { [CSRF_HEADER]: CSRF_TOKEN } : {})
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            title, start, end: end || null, allDay, description, location,
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone
          })
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || 'save failed');
        }
        const saved = await res.json();

        // 캘린더 반영
        if(isUpdate){
          const ev = calendar.getEventById(form.dataset.eventId);
          if(ev){
            ev.setProp('title', saved.title ?? title);
            ev.setDates(saved.start ?? start, (saved.end ?? end) || null, { allDay: saved.allDay ?? allDay });
          }else{
            calendar.addEvent(saved);
          }
        }else{
          calendar.addEvent(saved); // 서버가 toFullCalendar 형태로 돌려줌
        }

        closeModal();
        calendar.unselect();
      }catch(err){
        console.error(err);
        alert('저장에 실패했습니다.');
      }
    });

    // 초기 1회 로드
    (async function bootstrapLoad(){
      const view = calendar.view;
      try{
        const events = await loadEvents(view.currentStart, view.currentEnd);
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      }catch(e){ console.error(e); }
    })();
</script>
</body>
</html>
